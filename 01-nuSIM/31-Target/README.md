This directory contains code for the nuSTORM target and horn.

### Geometry
    
The script [nuSTORMTarget.py](nuSTORMTarget.py) creates the target and horn geometry
using [pyg4ometry](http://www.pp.rhul.ac.uk/bdsim/pyg4ometry) that can then be used in
[BDSIM]( http://www.pp.rhul.ac.uk/bdsim/manual) and [FLUKA](https://fluka.cern/home).
It implements a 46 cm-long cylindrical Inconel target, with a radius of 6.3 mm, inside
the bore of a 2.2 m-long aluminium magnetic horn that is filled with argon gas. The horn
has an inner conductor radius of 2 cm at the neck (2.5 mm thick), which increases to
8.5 cm (5.0 cm) at the upstream (downstream) ends, and an outer conductor radius of 10 cm.
The horn current is nominally set at 219 kA (from the Fermilab optimisation study).

### FLUKA

#### Input files
The [Fluka](Fluka) subdirectory contains additional files required for the FLUKA simulation:

1. [nuSTORMTarget.inp](Fluka/nuSTORMTarget.inp) is the Fluka input file. This is a copy of a file
generated by [nuSTORMTarget.py](nuSTORMTarget.py), for a 100 GeV proton beam with size
sigma = 2.67 mm (FWHM = 6.29 mm).
2. [magfld.f](Fluka/magfld.f) is the magnetic field user routine for the horn (argon gas
region). This file needs to be placed in the `FlukaInstall/src/user` directory, where
`FlukaInstall` is the location of the Fluka installation, and the Fluka exectauble needs
to be recompiled and linked. The field is `B = 0.02*I(kA)/r(cm) Tesla` for horn current
`I` and radius `r`.
3. [FieldPars.dat](Fluka/FieldPars.dat) contains 2 parameters: the horn current (kA) and
whether the current direction is positive (1.0) or negative (-1.0). This is used by the
`magfld.f` code. The nominal current is +219 kA (from the Fermilab optimisation study).
4. [mgdraw.f](Fluka/mgdraw.f) is a user routine to track pions and muons crossing the
downstream end of the horn within the outer conductor horn radius. This file also needs
to be placed in the `FlukaInstall/src/user` directory.
5. [linkDPMJET.txt](Fluka/linkDPMJET.txt)  is a file containing commands that need to be
run in order to compile the above `magfld.f` and `mgdraw.f` user routines, and to include
them in the Fluka executable, along with the `DPMJET` physics routines for hadronic
interaction and radioisotope modeling. The `FLUPRO` environment variable needs to
specify the full directory location of the Fluka installation.

#### Build and run instructions (CERN releases)

1. Download FLUKA from the [CERN](https://fluka.cern/download/latest-fluka-release) release page,
which requires at least a lightweight CERN account. You must also
[register](https://fluka.cern/download/registration) and wait for approval
(typically within a few working days). Version **4-3.0** and above is recommended.

2. Install FLUKA following the [instructions](https://fluka.cern/documentation/installation).
An example for 64-bit unix using the `gfortran9` compiler and `csh` (`tcsh`) would be:
```
tar zxvf fluka-4-3.0.x86-Linux-gfor9.tgz
cd fluka4-3.0
setenv FLUPRO ${PWD}
cd src
make
```
This creates the default FLUKA executables `fluka` and `flukadpm` (the latter is recommended) as well
as various auxiliary programs (for processing, converting and merging output files) in the directory
`$FLUPRO/bin`.

3. Copy (overwite) the [magfld.f](Fluka/magfld.f) (magnetic field) and [mgdraw.f](Fluka/mgdraw.f)
(particle tracking screen) files from the `nuSTORM/01-nuSIM/31-Target/Fluka` directory to the
`$FLUPRO/src/user` directory, where FLUPRO is the directory name of the FLUKA installation.

4. Create the `$FLUPRO/bin/flukadpm3` FLUKA executable to include the magnetic field
and particle tracking screen routines (`flukadpm3` could also be called anything you want):

```
cd $FLUPRO/src
$FLUPRO/bin/fff user/magfld.f
$FLUPRO/bin/fff user/mgdraw.f
$FLUPRO/bin/ldpmqmd -o $FLUPRO/bin/flukadpm3 user/magfld.o user/mgdraw.o
```

5. Copy the [FieldPars.dat](Fluka/FieldPars.dat) one-line file that specifies the horn current
(in kA) and polarity (1.0 for positive, -1.0 for negative) that is used by the magnetic field
routine [magfld.f](Fluka/magfld.f). The default current setting is +219kA, and different values
can be used in [FieldPars.dat](Fluka/FieldPars.dat).

6. Run the FLUKA executable `flukadpm3` with the [nuSTORMTarget.inp](Fluka/nuSTORMTarget.inp) input file
```
$FLUPRO/bin/rfluka -e $FLUPRO/bin/flukadpm3 -N0 -M1 nuSTORMTarget
```
The `rfluka` script uses the selected executable (-e) followed by the run numbers and the
input file (which excludes the `.inp` extension). If successful, this will create the various
output files described below.

7. The geometry can be modified by using the [nuSTORMTarget.py](nuSTORMTarget.py) python script.
This will automatically create an updated `nuSTORMTarget.inp` input file.

#### Output files
The Fluka simulation creates several output files. Assuming the Fluka input file is called
`nuSTORMTarget`, they are:
1. `nuSTORMTarget001_fort.21` is the energy deposition density (GeV/cc/proton) in the target
and horn volumes (usrbin binary format).
2. `nuSTORMTarget001_fort.22` is the energy deposition density (GeV/cc/proton) in the target
only (usrbin binary format).
3. `nuSTORMTarget001_evt.txt` is an ASCII text file containing the energy deposition (GeV)
in each volume region for each individual event.
4. `nuSTORMTarget001_output.txt` is an ASCII text file containing the coordinates, momenta
and other information for pions and muons crossing the downstream end of the horn, within
the outer conductor aperture radius. This is performed by the `BXDRAW` subroutine in
[mgdraw.f](Fluka/mgdraw.f). The data columns are event number, Fluka particle id, total
and kinetic energy (GeV), weight, (x,y,z) position (cm), direction cosines (cx,cy,cz) and
the particle flight time (sec).

#### Particle distributions
The python script [getPiMuDist.py](Fluka/getPiMuDist.py) stores the pion and muon information
from `nuSTORMTarget001_output.txt` in [ROOT](https://root.cern.ch) format within a
[TTree](https://root.cern/doc/master/classTTree.html) called `Data`. It contains the
following variables (one entry per pion or muon):
- Event number `iEvt`
- PDG particle code `PDGId`
- Total energy `totE` (GeV)
- Kinetic energy `KE` (GeV)
- The x position `x` (cm)
- The y position `y` (cm)
- The z position `z` (cm)
- The radial position `rxy` (cm)
- The x momentum `px` (GeV)
- The y momentum `py`(GeV)
- The z momentum `pz` (GeV)
- The transverse momentum `pT` (GeV)
- The total momentum `p` (GeV)
- The particle flight time `tns` (ns)
- The particle `weight`

The python script [asciiFromROOT.py](Fluka/asciiFromROOT.py) writes the pion and muon
information from the previous ROOT TTree structure into a gzipped ASCII text file that
can be used to specify the input beam distribution in
[BDSIM](http://www.pp.rhul.ac.uk/bdsim/manual/model_control.html#userfile),
where each row contains the variables `x y z px py pz PDGId totE`.

#### FermiGrid job submission
The python script [createFermiGridJobs.py](Fluka/createFermiGridJobs.py) creates a shell
script that submits Fluka simulation runs on the FermiGrid. It uses
[submitFermiGridJob.py](Fluka/submitFermiGridJob.py) to submit each individual job.
